<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.cloudshiba.pubsub.repository.OrderRepository">

    <resultMap id="orderResultMap" type="com.cloudshiba.pubsub.entity.Order">
        <id column="id" property="id"/>
        <result column="no" property="no"/>
        <result column="product_id" property="productId"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime" javaType="java.time.Instant" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="orderColumns">
        a.id,
        a.no,
        a.product_id,
        a.status,
        a.create_time
    </sql>

    <insert id="insert">
        INSERT INTO `order`(
        id,
        no,
        product_id,
        status,
        create_time
        ) VALUES (
        #{id},
        #{no},
        #{productId},
        #{status},
        #{createTime}
        )
    </insert>


    <!-- where 条件 -->
    <sql id="whereColumnList">
        <if test="status != null">
            and a.status = #{status}
        </if>
    </sql>

    <select id="findList" resultMap="orderResultMap">
        select
        <include refid="orderColumns"/>
        from `order` a
        where a.product_id = #{order.productId} and a.status = #{order.status} order by a.id asc limit #{limit} offset #{offset}
    </select>

    <select id="getTotal" resultType="java.lang.Integer">
        select
        count(1)
        from `order`
        where product_id = #{productId} and status = #{status}
    </select>

    <!-- 更新用户 -->
    <update id="update">
        update `order` set
        <if test="status != null">
            status = #{status}
        </if>
        where id = #{id}
    </update>

    <insert id="insertBatch" useGeneratedKeys="false">
        INSERT INTO `order` (
        id,
        no,
        product_id,
        status,
        create_time
        )
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.id}, #{item.no}, #{item.productId}, #{item.status}, #{item.createTime})
        </foreach>
    </insert>

</mapper>
